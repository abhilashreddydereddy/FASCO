<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fasco ‚Äî Dashboard</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --accent:#1f6feb;
      --muted:#6b7280;
      --shadow: 0 6px 18px rgba(17,24,39,0.06);
      --danger:#dc2626;
      --warning:#f59e0b;
      --success:#10b981;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      background:var(--bg);
      color:#111827;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .navbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 20px;
      background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.8));
      backdrop-filter:blur(6px);
      box-shadow:var(--shadow);
      position:sticky;
      top:0;
      z-index:40;
      flex-shrink: 0;
    }
    .left-section{display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:8px;background:var(--accent);display:inline-grid;place-items:center;color:white;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .nav-links{display:flex;gap:18px;align-items:center}
    .nav-links a{color:var(--muted);text-decoration:none;font-weight:600}
    .nav-links a:hover{color:var(--accent)}
    .actions{display:flex;gap:12px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:var(--card);cursor:pointer;font-size:14px;font-weight:500;transition:all .2s}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn.primary{background:var(--accent);color:white;border:none}

        /* --- Modern Version --- */

    .hamburger {
      border: 0;
      background: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      
      /* Use gap for spacing instead of margin */
      gap: 6px; 
    }

    .hamburger .line {
      width: 22px;
      height: 2px;
      background: #111827;
      /* No margin needed! */
      transition: transform 0.2s ease, opacity 0.2s ease;
      backface-visibility: hidden;
    }

    .hamburger.open .line:nth-child(1){transform:translateY(5px) rotate(45deg)}
    .hamburger.open .line:nth-child(2){opacity:0}
    .hamburger.open .line:nth-child(3){transform:translateY(-5px) rotate(-45deg)}

    .mobile-menu{
      display: flex; 
      flex-direction: column;
      gap: 8px;
      padding: 28px 20px;
      position: fixed;
      top: 60px;
      left: 0;
      height: calc(100% - 60px); 
      width: 280px;  
      background: var(--card);
      z-index: 50;
      box-shadow: var(--shadow);
      transform: translateX(-280px); 
      transition: transform 0.3s ease-in-out;
    }

    .mobile-menu.open {
      transform: translateX(0);
    }

    .mobile-menu a{padding:8px 0;color:var(--muted);text-decoration:none}

    .container{
      display: flex;
      flex-direction: column;
      padding:20px;
      height:100%;
      overflow-y:auto;
      width: 100%;
    }

    .card-image {
        max-width: 100%; 
        height: auto;
        display: block;
        border-radius: 6px; 
    }

    #dash {
        font-size: large;
        color: rgb(153, 30, 30);
    }

    #main-body {
      flex-grow: 1;
      position: relative;
      overflow: hidden;
      transition: margin-left 0.3s ease-in-out;
    }

    #main-body.pushed {
      margin-left: 280px;
    }

    /* Dashboard Specific Styles */
    .dashboard-header{
      margin-bottom:24px;
    }
    
    .dashboard-header h2{
      margin:0 0 8px 0;
      font-size:28px;
    }

    .dashboard-header p{
      margin:0;
      color:var(--muted);
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
      margin-bottom:24px;
    }

    .stat-card{
      background:var(--card);
      padding:24px;
      border-radius:12px;
      box-shadow:var(--shadow);
      transition:transform .2s;
    }

    .stat-card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(17,24,39,0.12);
    }

    .stat-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:12px;
    }

    .stat-icon{
      width:40px;
      height:40px;
      border-radius:10px;
      display:grid;
      place-items:center;
      font-size:20px;
    }

    .stat-icon.blue{background:#dbeafe;color:#1e40af}
    .stat-icon.red{background:#fee2e2;color:#991b1b}
    .stat-icon.green{background:#d1fae5;color:#065f46}
    .stat-icon.orange{background:#fed7aa;color:#92400e}

    .stat-info h4{
      margin:0 0 4px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:500;
    }

    .stat-value{
      font-size:32px;
      font-weight:700;
      margin:0 0 8px 0;
    }

    .stat-change{
      font-size:13px;
      font-weight:600;
    }

    .stat-change.positive{color:var(--success)}
    .stat-change.negative{color:var(--danger)}

    .charts-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:20px;
      margin-bottom:24px;
    }

    .chart-card{
      background:var(--card);
      padding:24px;
      border-radius:12px;
      box-shadow:var(--shadow);
    }

    .chart-card h3{
      margin:0 0 20px 0;
      font-size:18px;
      font-weight:600;
    }

    .chart-container{
      height:300px;
      position:relative;
    }

    canvas{
      max-width:100%;
      max-height:100%;
    }

    .recent-section{
      background:var(--card);
      padding:24px;
      border-radius:12px;
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }

    .recent-section h3{
      margin:0 0 16px 0;
      font-size:18px;
      font-weight:600;
    }

    .recent-table{
      width:100%;
      border-collapse:collapse;
    }

    .recent-table th{
      text-align:left;
      padding:12px 8px;
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      border-bottom:2px solid #f3f4f6;
    }

    .recent-table td{
      padding:14px 8px;
      border-bottom:1px solid #f9fafb;
      font-size:14px;
    }

    .recent-table tbody tr:hover{
      background:#f9fafb;
    }

    .status-badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:12px;
      font-size:11px;
      font-weight:600;
    }

    .status-badge.low{background:#fee2e2;color:#991b1b}
    .status-badge.medium{background:#fed7aa;color:#92400e}
    .status-badge.high{background:#d1fae5;color:#065f46}
    .status-badge.paid{background:#d1fae5;color:#065f46}
    .status-badge.pending{background:#fed7aa;color:#92400e}

    @media (max-width:900px){
      .charts-grid{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }

    @media (max-width:720px){
      .nav-links{display:none}
      .actions{display:none}
      .stats-grid{grid-template-columns:1fr}
      .recent-section{overflow-x:auto}
      .recent-table{min-width:600px}
    }

  </style>
</head>
<body>
  
  <header class="navbar">
    <div class="left-section">
      <button class="hamburger" id="hamburgerBtn" aria-expanded="false" aria-label="Open menu">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </button>
      <div class="brand">
        <div class="logo">
            <img class="card-image" src="assets/icons/logo.png" alt="Fasco Logo">
        </div>
        <div>
          <h1>Fasco</h1>
          <div style="font-size:12px;color:var(--muted)">Inventory & Billing</div>
        </div>
      </div>
    </div>

    <nav class="nav-links" aria-label="Primary">
      <a id="dash" href="home.html">Dashboard</a>
      <a href="inventory.html">Inventory</a>
      <a href="sales.html">Sales</a>
      <a href="orders.html">Orders</a>
      <a href="users.html">Users</a>
    </nav>

    <div class="actions">
      <button class="btn">Profile</button>
      <button class="btn primary">New Invoice</button>
      <button class="btn danger" id="logoutBtn">Log Out</button>
    </div>
  </header>

  <div id="main-body">
    <div id="mobileMenu" class="mobile-menu">
      <a href="home.html">Dashboard</a>
      <a href="inventory.html">Products</a>
      <a href="sales.html">Sales</a>
      <a href="#">Reports</a>
      <a href="#">Settings</a>
    </div>

    <div class="container">
      <div class="dashboard-header">
        <h2>Dashboard Overview</h2>
        <p>Real-time insights into your business performance</p>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-info">
              <h4>Total Products</h4>
              <p class="stat-value" id="totalProducts">0</p>
              <span class="stat-change positive" id="productsChange">Loading...</span>
            </div>
            <div class="stat-icon blue">üì¶</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-info">
              <h4>Low Stock Alert</h4>
              <p class="stat-value" id="lowStockCount">0</p>
              <span class="stat-change negative" id="lowStockText">Items need restock</span>
            </div>
            <div class="stat-icon red">‚ö†Ô∏è</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-info">
              <h4>Total Orders</h4>
              <p class="stat-value" id="totalOrders">0</p>
              <span class="stat-change positive" id="ordersChange">Loading...</span>
            </div>
            <div class="stat-icon green">üõí</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-info">
              <h4>Revenue (Today)</h4>
              <p class="stat-value" id="todayRevenue">‚Çπ0</p>
              <span class="stat-change positive" id="revenueChange">Loading...</span>
            </div>
            <div class="stat-icon orange">üí∞</div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Inventory by Category</h3>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>Sales Trend (Last 7 Days)</h3>
          <div class="chart-container">
            <canvas id="salesTrendChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>Stock Status Distribution</h3>
          <div class="chart-container">
            <canvas id="stockStatusChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>Top Selling Products</h3>
          <div class="chart-container">
            <canvas id="topProductsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="recent-section">
        <h3>Recent Orders</h3>
        <table class="recent-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Date</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recentOrdersBody">
            <tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">Loading orders...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Low Stock Items -->
      <div class="recent-section">
        <h3>Low Stock Items</h3>
        <table class="recent-table">
          <thead>
            <tr>
              <th>Product Code</th>
              <th>Product Name</th>
              <th>Category</th>
              <th>Current Stock</th>
              <th>Min Stock</th>
              <th>Priority</th>
            </tr>
          </thead>
          <tbody id="lowStockBody">
            <tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">Loading stock data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    const API_PRODUCTS = "http://localhost:5000/api/dashboard/products";
    const API_ORDERS = "http://localhost:5000/api/dashboard/orders";
    
    let products = [];
    let orders = [];
    let charts = {};

    // Fetch all data
    async function fetchDashboardData() {
      try {
        const [productsRes, ordersRes] = await Promise.all([
          fetch(API_PRODUCTS),
          fetch(API_ORDERS)
        ]);
        
        products = await productsRes.json();
        orders = await ordersRes.json();
        
        updateDashboard();
      } catch (err) {
        console.error("Error fetching dashboard data:", err);
      }
    }

    function updateDashboard() {
      updateStats();
      renderCharts();
      renderRecentOrders();
      renderLowStockItems();
    }

    function updateStats() {
      // Total Products
      document.getElementById('totalProducts').textContent = products.length;
      document.getElementById('productsChange').textContent = `${products.length} items in stock`;
      
      // Low Stock
      const lowStock = products.filter(p => p.stock <= p.min_stock && p.stock > 0).length;
      document.getElementById('lowStockCount').textContent = lowStock;
      document.getElementById('lowStockText').textContent = `${lowStock} items need restock`;
      
      // Total Orders
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('ordersChange').textContent = `${orders.length} orders total`;
      
      // Today's Revenue
      const today = new Date().toISOString().split('T')[0];
      const todayOrders = orders.filter(o => o.order_date.startsWith(today));
      const todayRevenue = todayOrders.reduce((sum, o) => sum + parseFloat(o.total_amount || 0), 0);
      document.getElementById('todayRevenue').textContent = '‚Çπ' + todayRevenue.toLocaleString();
      document.getElementById('revenueChange').textContent = `${todayOrders.length} orders today`;
    }

    function renderCharts() {
      // 1. Category Distribution
      const categoryData = {};
      products.forEach(p => {
        categoryData[p.category] = (categoryData[p.category] || 0) + p.stock;
      });

      if (charts.category) charts.category.destroy();
      charts.category = new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(categoryData),
          datasets: [{
            data: Object.values(categoryData),
            backgroundColor: ['#1f6feb', '#10b981', '#f59e0b', '#dc2626', '#8b5cf6', '#06b6d4']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // 2. Sales Trend (Last 7 Days)
      const last7Days = [];
      const salesByDay = {};
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last7Days.push(dateStr);
        salesByDay[dateStr] = 0;
      }
      
      orders.forEach(o => {
        const orderDate = o.order_date.split('T')[0];
        if (salesByDay.hasOwnProperty(orderDate)) {
          salesByDay[orderDate] += parseFloat(o.total_amount || 0);
        }
      });

      if (charts.salesTrend) charts.salesTrend.destroy();
      charts.salesTrend = new Chart(document.getElementById('salesTrendChart'), {
        type: 'line',
        data: {
          labels: last7Days.map(d => new Date(d).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
          datasets: [{
            label: 'Revenue (‚Çπ)',
            data: last7Days.map(d => salesByDay[d]),
            borderColor: '#1f6feb',
            backgroundColor: 'rgba(31, 111, 235, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // 3. Stock Status
      const inStock = products.filter(p => p.stock > p.min_stock).length;
      const lowStockCount = products.filter(p => p.stock <= p.min_stock && p.stock > 0).length;
      const outStock = products.filter(p => p.stock === 0).length;

      if (charts.stockStatus) charts.stockStatus.destroy();
      charts.stockStatus = new Chart(document.getElementById('stockStatusChart'), {
        type: 'pie',
        data: {
          labels: ['In Stock', 'Low Stock', 'Out of Stock'],
          datasets: [{
            data: [inStock, lowStockCount, outStock],
            backgroundColor: ['#10b981', '#f59e0b', '#dc2626']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // 4. Top Products (based on order items - simplified: by stock level for demo)
      const topProducts = [...products]
        .sort((a, b) => (b.stock * b.price) - (a.stock * a.price))
        .slice(0, 5);

      if (charts.topProducts) charts.topProducts.destroy();
      charts.topProducts = new Chart(document.getElementById('topProductsChart'), {
        type: 'bar',
        data: {
          labels: topProducts.map(p => p.name.substring(0, 20)),
          datasets: [{
            label: 'Stock Value (‚Çπ)',
            data: topProducts.map(p => p.stock * p.price),
            backgroundColor: '#1f6feb'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }

    function renderRecentOrders() {
      const tbody = document.getElementById('recentOrdersBody');
      const recentOrders = [...orders].sort((a, b) => 
        new Date(b.order_date) - new Date(a.order_date)
      ).slice(0, 5);

      if (recentOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">No orders yet</td></tr>';
        return;
      }

      tbody.innerHTML = recentOrders.map(order => `
        <tr>
          <td><strong>#${order.id}</strong></td>
          <td>${order.customer_name || 'Guest'}</td>
          <td>${new Date(order.order_date).toLocaleDateString()}</td>
          <td>${order.item_count || '-'} items</td>
          <td><strong>‚Çπ${parseFloat(order.total_amount).toLocaleString()}</strong></td>
          <td><span class="status-badge paid">Paid</span></td>
        </tr>
      `).join('');
    }

    function renderLowStockItems() {
      const tbody = document.getElementById('lowStockBody');
      const lowStockItems = products
        .filter(p => p.stock <= p.min_stock)
        .sort((a, b) => (a.stock / a.min_stock) - (b.stock / b.min_stock))
        .slice(0, 5);

      if (lowStockItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">All items are well stocked!</td></tr>';
        return;
      }

      tbody.innerHTML = lowStockItems.map(item => {
        const ratio = item.stock / item.min_stock;
        const priority = item.stock === 0 ? 'high' : ratio < 0.5 ? 'high' : 'medium';
        const priorityText = item.stock === 0 ? 'Critical' : ratio < 0.5 ? 'High' : 'Medium';
        
        return `
          <tr>
            <td><strong>${item.code}</strong></td>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${item.stock}</td>
            <td>${item.min_stock}</td>
            <td><span class="status-badge ${priority}">${priorityText}</span></td>
          </tr>
        `;
      }).join('');
    }

    // Mobile Menu
    const btn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const mainBody = document.getElementById('main-body');

    function toggleMenu(){
      const open = btn.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      mobileMenu.classList.toggle('open', open);
      mainBody.classList.toggle('pushed', open);
    }

    btn.addEventListener('click', toggleMenu);

    window.addEventListener('resize', ()=>{
      if(window.innerWidth > 720){
        mobileMenu.classList.remove('open');
        btn.classList.remove('open');
        btn.setAttribute('aria-expanded','false');
        mainBody.classList.remove('pushed');
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', fetchDashboardData);

    // --- Log Out Button ---
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token'); // Clear the token
      window.location.href = 'login.html'; // Go back to login page
    });
  </script>
</body>
</html>